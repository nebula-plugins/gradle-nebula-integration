apply plugin: "java"

repositories {
    maven {
        url '../repo'
    }
}

project.dependencies.components.all(AlignGroup.class)
class AlignGroup implements ComponentMetadataRule {
    void execute(ComponentMetadataContext ctx) {
        ctx.details.with { it ->
            if (it.getId().getGroup().startsWith("test.nebula")) {
                it.belongsTo("aligned-group:test.nebula:${it.getId().getVersion()}")
            }
        }
    }
}

import org.gradle.api.internal.artifacts.ivyservice.ivyresolve.strategy.*
def VERSIONED_COMPARATOR = new DefaultVersionComparator()
def VERSION_COMPARATOR = VERSIONED_COMPARATOR.asVersionComparator()
def VERSION_SCHEME = new DefaultVersionSelectorScheme(VERSIONED_COMPARATOR)
configurations.all {
    resolutionStrategy.dependencySubstitution.all {
        def substituteFromVersion = "1.2.0"
        def substituteToVersion = "1.3.0"
        def substitutionReason = "substitution from '${it.requested.group}:${it.requested.module}:$substituteFromVersion' to '${it.requested.group}:${it.requested.module}:$substituteToVersion'"
        def selector = VERSION_SCHEME.parseSelector(substituteFromVersion)
        if (it.requested.group.startsWith("test.nebula") && selector.accept(it.requested.version)) {
            it.useTarget("${it.requested.group}:${it.requested.module}:${substituteToVersion}", substitutionReason)
        }
    }
}
